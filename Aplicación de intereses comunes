using System;
using System.Collections.Generic;
using static System.Console;
using static System.Convert;

namespace Proyecto_Estructura
{

    public class Usuario
    {
        public string Nombre { get; set; }
        public LinkedList<string> Intereses { get; private set; }

        //complejidad O(1)
        public Usuario(string nombre)
        {
            if (string.IsNullOrWhiteSpace(nombre))
                throw new ArgumentException("El nombre no debe estar vacío");

            Nombre = nombre;
            Intereses = new LinkedList<string>();
        }
        //complejidad O(n)
        //Se agrega un interés al usuario si no está repetido ni vacio
        public void AgregarIntereses(string interes)
        {
            if (string.IsNullOrWhiteSpace(interes))
                throw new ArgumentException("No se puede agregar un interés vacío");

            if (Intereses.Contains(interes)) //O(n)
                throw new InvalidOperationException($"El interes {interes} ya se encuentra agregado en la lista");

            Intereses.AddLast(interes); //O(1)
        }

        //Recursión que muestra los intereses del usuario
        //complejidad O(n)
        private void MostrarInteresesRecursivo(LinkedListNode<string> nodo)
        {
            if (nodo == null)
                return;
            WriteLine($"- {nodo.Value}");

            MostrarInteresesRecursivo(nodo.Next);

        }

        /*Recursión que cuenta los intereses del usuario
        complejidad O(n)*/
        private int ContarInteresesRecursivo(LinkedListNode<string> nodo)
        {
            if (nodo == null)
                return 0;
            return ContarInteresesRecursivo(nodo.Next) + 1;
        }


        //complejidad O(n)
        //Muestra los intereses del usuario y el total de intereses
        public void MostrarIntereses()
        {
            WriteLine($"\nIntereses de {Nombre}: ");
            if (Intereses.Count == 0)
            {
                WriteLine("No tiene intereses seleccionados");
                return;
            }
            MostrarInteresesRecursivo(Intereses.First);
            int total = ContarInteresesRecursivo(Intereses.First);
            WriteLine($"\nTotal de intereses seleccionados por {Nombre}: {total}");

        }
    }
    public class GrafosUsuarios
    {
        private List<List<int>> adyacencia;
        private List<Usuario> usuarios;


        /* Se inicializa el grafo vacío
         * complejidad O(1) */
        public GrafosUsuarios()
        {
            usuarios = new List<Usuario>();
            adyacencia = new List<List<int>>();
        }

        /* Agrega un nuevo usuario al grafo
         * complejidad O(n) */
        public void AgregarUsuario(Usuario usuar)
        {
            foreach (var existente in usuarios)
            {
                if (existente.Nombre.Equals(usuar.Nombre, StringComparison.OrdinalIgnoreCase))
                {
                    WriteLine($"\n El usuario '{usuar.Nombre}' ya existe");
                    return; // sale del método sin agregar
                }

            }

            usuarios.Add(usuar);
            adyacencia.Add(new List<int>());
            WriteLine($"\nUsuario '{usuar.Nombre}' agregado correctamente");
        }
        


        /* Genera conexiones entre usuarios que tienen intereses comunes
         * complejidad O(n^2 * m) */
        public void GenerarConexiones()
        {
            for (int i = 0; i < usuarios.Count; i++)
            {
                for (int j = i + 1; j < usuarios.Count; j++)
                {
                    foreach (var intereses in usuarios[i].Intereses)
                    {
                        if (usuarios[j].Intereses.Contains(intereses))
                        {
                            if (adyacencia[i].Contains(j))
                                throw new Exception($"Ya existe conexión entre {usuarios[i].Nombre} y {usuarios[j].Nombre}.");

                            adyacencia[i].Add(j);
                            adyacencia[j].Add(i);
                            WriteLine($"Conexión creada entre {usuarios[i].Nombre} y {usuarios[j].Nombre} por interés en común '{intereses}'");
                            break;
                        }
                        
                    }
                }
            }
        }

       /* Recorre el grafo con DFS
        * complejidad : O(V+E) */
        public void DFS(int i, int[] visitados = null)
        {
            if (visitados == null)
                visitados = new int[usuarios.Count];

            if (visitados[i] == 1)
                return;

            visitados[i] = 1;
            WriteLine($"Visitando a {usuarios[i].Nombre}");

            foreach (int j in adyacencia[i])
            {
                if (visitados[j] == 0)
                    DFS(j, visitados);
            }
        }

        /*Recorre el grafo con BFS
         * complejidad: O(V+E) */
        public void BFS(int i)
        {
            int[] visitados = new int[usuarios.Count];
            Queue<int> cola = new Queue<int>();

            cola.Enqueue(i);
            visitados[i] = 1;

            while (cola.Count > 0)
            {
                int actual = cola.Dequeue();
                WriteLine($"Visitando a {usuarios[actual].Nombre}");

                foreach (int j in adyacencia[actual])
                {
                    if (visitados[j] == 0)
                    {
                        visitados[j] = 1;
                        cola.Enqueue(j);
                    }
                }
            }
            
        }


        /* Muestras las conexiones del grafo
         * complejidad O(n^2) */

        public void MostrarGrafos()
        {
            WriteLine("\nConexiones entre usuarios: ");
            for (int i = 0; i < usuarios.Count; i++)
            {
                string conexiones = adyacencia[i].Count == 0 ? "Ninguna conexión"
                    : string.Join(", ", adyacencia[i].ConvertAll(j => usuarios[j].Nombre));
                WriteLine($"{usuarios[i].Nombre} está conectado con: {conexiones}");
            }

        }
        public int CantidadUsuarios => usuarios.Count;
    }

    class Program
    {
        static void Main()
        {
            List<string> listaIntereses = new List<string>()
{
  "Música","Deporte","Libros","Películas","Series","Lugares","Tecnología",
  "Arte","Comida","Paises","Idiomas","Fotografia","Videojuegos","Moda","Historia",
};
            WriteLine("Bienvenid@ al sistema de intereses comunes");
            GrafosUsuarios grafo = new GrafosUsuarios();

            while (true)
            {
                WriteLine("\nIngrese nombre de usuario o * para salir: ");
                string nombre = ReadLine();
                if (nombre.ToLower() == "*") break;

                Usuario user;

                try
                {
                    user = new Usuario(nombre);
                }
                catch (Exception ex)
                { Console.WriteLine($"Intente de nuevo {ex.Message}");
                    continue;
                }

                    WriteLine("\nElige tus intereses favoritos");
                for (int i = 0; i < listaIntereses.Count; i++)
                {
                    WriteLine($"{i + 1}.{listaIntereses[i]}");
                }
                while (true)
                {
                    WriteLine("\nIngrese un número o 0 para salir");
                    int opcion;
                    try
                    {
                         opcion = ToInt32(ReadLine());
                    }
                    catch
                    {
                        WriteLine("Debes ingresar un número");
                        continue;
                    
                    }

                    if (opcion == 0) break;
                    if (opcion > 0 && opcion <= listaIntereses.Count)
                    {
                        string interesesSeleccionado = listaIntereses[opcion - 1];
                        try
                        {
                            user.AgregarIntereses(interesesSeleccionado);
                            WriteLine($"Interes agregado: {interesesSeleccionado}");
                        }
                        catch (Exception ex)
                        {
                            WriteLine(ex.Message);
                        }
                    }
                    else
                        WriteLine("Número invalido. Inténtalo de nuevo");
                }
                grafo.AgregarUsuario(user);
            }

            if (grafo.CantidadUsuarios > 1)
            {
                grafo.GenerarConexiones();
                grafo.MostrarGrafos();

                WriteLine("\nDFS");
                grafo.DFS(0);

                WriteLine("\nBFS");
                grafo.BFS(0);
            }
            else
            {
                WriteLine("No hay suficientes usuarios para crear conexiones.");
            }
        }
    }
}







